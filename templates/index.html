<!DOCTYPE html>
<html>
<head>
    <title>Zotero References</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script>
        function validateSelection() {
            const checked = document.querySelectorAll('input[name="selected_items"]:checked');
            console.log("Selected checkboxes:", checked);
            console.log("Number of selected items:", checked.length);
            
            // Log the values of selected checkboxes
            const selectedValues = Array.from(checked).map(checkbox => checkbox.value);
            console.log("Selected values:", selectedValues);
            
            if (checked.length === 0) {
                alert('Please select at least one item');
                return false;
            }
            
            // Add a hidden field with selected values for debugging
            const form = document.querySelector('.bulk-tag-form');
            const debugField = document.createElement('input');
            debugField.type = 'hidden';
            debugField.name = 'debug_selected';
            debugField.value = JSON.stringify(selectedValues);
            form.appendChild(debugField);
            
            return true;
        }
    </script>
</head>
<body>
    <!-- Add flash messages display at the top of the template -->
    <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="container">
        <div class="sidebar">
            <h2>Available Tags</h2>
            
            <!-- Tag filtering and sorting controls -->
            <div class="tag-controls">
                <input type="text" id="tag-filter" placeholder="Filter tags..." class="tag-filter">
                <select id="tag-sort" class="tag-sort">
                    <option value="alpha">Sort alphabetically</option>
                    <option value="count" selected>Sort by count</option>
                </select>
            </div>
            
            <!-- Clear filters button moved here -->
            {% if selected_tags %}
            <div class="clear-filter-container">
                <button class="clear-filter" onclick="window.location.href='/'">
                    ✕ Clear All Filters
                </button>
            </div>
            {% endif %}
            
            <!-- Scrollable tag cloud container -->
            <div class="tag-cloud-container">
                <div id="tag-cloud">
                    {% for tag, count in tag_counts.items() %}
                        <div class="tag {% if tag in selected_tags %}selected-tag{% endif %}"
                             onclick="toggleTag('{{ tag }}')"
                             data-count="{{ count }}">
                            {{ tag }} ({{ count }})
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Form remains unchanged -->
        <div class="main-content">
            <!-- Empty filter controls div - Active filters section removed -->
            <div class="filter-controls">
            </div>

            <!-- Form remains unchanged -->
            <form method="post" enctype="multipart/form-data" onsubmit="return validateSelection()" class="bulk-tag-form">
                <!-- Add this right after the bulk-controls div -->
                <div class="bulk-controls">
                    <input type="text" name="new_tag" placeholder="Add tags (separate with comma or semicolon)" required>
                    <button type="submit" class="add-tag-button">
                        Add Tags to Selected
                    </button>
                </div>
                
                <!-- Add this new container for common tags -->
                <div class="common-tags-container" id="common-tags-container" style="display: none;">
                    <span class="common-tags-label">Common tags:</span>
                    <div id="common-tags-list"></div>
                </div>
                
                <h2>References ({{ items|length }})</h2>
                {% if items %}
                    {% for item in items %}
                        <div class="item">
                            <!-- Ensure checkbox has correct name and value -->
                            <input type="checkbox" 
                                name="selected_items" 
                                value="{{ item.id }}"
                                id="item_{{ item.id }}">
                            <!-- Replace the commented out item-tags div with this version -->
                            <div class="item-title"><strong>{{ item.title }}</strong></div>
                            <div class="item-author">{{ item.author }}</div>
                            <div class="item-date">{{ item.date }}</div>
                            <div class="item-tags">
                                Tags: 
                                {% for tag in item.tags %}
                                    <span class="tag">
                                        {{ tag }}
                                        <button type="button" class="close-tag" title="Remove tag" 
                                                onclick="removeTag('{{ tag }}', {{ item.id }})">&times;</button>
                                    </span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No items found matching the selected tags.</p>
                {% endif %}
            </form>
        </div>
    </div>

    <script>
        // Add this function to your existing script section
        function removeTag(tagName, itemId) {
            // Create a form dynamically
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('remove_tag') }}";
            
            // Add tag name input
            const tagInput = document.createElement('input');
            tagInput.type = 'hidden';
            tagInput.name = 'tag_name';
            tagInput.value = tagName;
            form.appendChild(tagInput);
            
            // Add item id input
            const itemInput = document.createElement('input');
            itemInput.type = 'hidden';
            itemInput.name = 'item_id';
            itemInput.value = itemId;
            form.appendChild(itemInput);
            
            // Add form to body, submit it, and remove it
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }
        
        // Your existing functions remain unchanged
        function toggleTag(tag) {
            const currentTags = new URLSearchParams(window.location.search).getAll('tag');
            const newTags = currentTags.includes(tag) 
                ? currentTags.filter(t => t !== tag)
                : [...currentTags, tag];
            
            const params = new URLSearchParams();
            newTags.forEach(t => params.append('tag', t));
            window.location.search = params.toString();
        }
    
        // 添加标签过滤和排序功能
        document.addEventListener('DOMContentLoaded', function() {
            const tagFilter = document.getElementById('tag-filter');
            const tagSort = document.getElementById('tag-sort');
            const tagCloud = document.getElementById('tag-cloud');
            const tags = Array.from(tagCloud.getElementsByClassName('tag'));
            
            // 过滤标签
            tagFilter.addEventListener('input', function() {
                const filterText = this.value.toLowerCase();
                
                tags.forEach(tag => {
                    const tagText = tag.textContent.toLowerCase();
                    if (tagText.includes(filterText)) {
                        tag.style.display = '';
                        // 高亮匹配部分
                        if (filterText) {
                            tag.classList.add('tag-highlight');
                        } else {
                            tag.classList.remove('tag-highlight');
                        }
                    } else {
                        tag.style.display = 'none';
                    }
                });
            });
            
            // 排序标签
            tagSort.addEventListener('change', function() {
                const sortMethod = this.value;
                
                tags.sort((a, b) => {
                    if (sortMethod === 'alpha') {
                        // 按字母排序
                        return a.textContent.localeCompare(b.textContent);
                    } else {
                        // 按数量排序
                        const countA = parseInt(a.getAttribute('data-count'));
                        const countB = parseInt(b.getAttribute('data-count'));
                        return countB - countA; // 降序
                    }
                });
                
                // 重新添加排序后的标签
                tags.forEach(tag => {
                    tagCloud.appendChild(tag);
                });
            });
            
            // 初始化排序
            tagSort.dispatchEvent(new Event('change'));
        });
    </script>
    <script>
        // Add this function to your existing script section
        function updateCommonTags() {
            const checked = document.querySelectorAll('input[name="selected_items"]:checked');
            if (checked.length === 0) {
                document.getElementById('common-tags-container').style.display = 'none';
                return;
            }
            
            // Get all selected item IDs
            const selectedItemIds = Array.from(checked).map(checkbox => checkbox.value);
            
            // Find common tags among selected items
            const allItemTags = {};
            selectedItemIds.forEach(itemId => {
                const item = document.getElementById(`item_${itemId}`).closest('.item');
                const tagElements = item.querySelectorAll('.item-tags .tag');
                
                if (!allItemTags[itemId]) {
                    allItemTags[itemId] = [];
                }
                
                tagElements.forEach(tagEl => {
                    // Get only the text content of the tag, excluding the close button
                    const tagText = tagEl.childNodes[0].textContent.trim();
                    allItemTags[itemId].push(tagText);
                });
            });
            
            // Find tags that exist in all selected items
            let commonTags = [];
            if (selectedItemIds.length > 0) {
                commonTags = [...allItemTags[selectedItemIds[0]]];
                for (let i = 1; i < selectedItemIds.length; i++) {
                    commonTags = commonTags.filter(tag => 
                        allItemTags[selectedItemIds[i]].includes(tag)
                    );
                }
            }
            
            // Update the common tags display
            const commonTagsContainer = document.getElementById('common-tags-container');
            const commonTagsList = document.getElementById('common-tags-list');
            
            if (commonTags.length > 0) {
                commonTagsContainer.style.display = 'flex';
                commonTagsList.innerHTML = '';
                
                commonTags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'common-tag';
                    tagSpan.innerHTML = `
                        ${tag}
                        <button type="button" class="remove-common-tag" 
                                onclick="removeTagFromSelected('${tag}')">&times;</button>
                    `;
                    commonTagsList.appendChild(tagSpan);
                });
            } else {
                commonTagsContainer.style.display = 'none';
            }
        }
        
        // Function to remove a tag from all selected items
        function removeTagFromSelected(tagName) {
            const checked = document.querySelectorAll('input[name="selected_items"]:checked');
            const selectedItemIds = Array.from(checked).map(checkbox => checkbox.value);
            
            // Create FormData to properly handle multiple values with the same name
            const formData = new FormData();
            formData.append('tag_name', tagName);
            
            // Add each item ID separately
            selectedItemIds.forEach(itemId => {
                formData.append('item_ids', itemId);
            });
            
            // Get current URL parameters to pass to the server
            const currentUrl = new URL(window.location.href);
            const selectedTags = currentUrl.searchParams.getAll('tag');
            
            // Add the current selected tags to the request
            selectedTags.forEach(tag => {
                formData.append('selected_tags', tag);
            });
            
            // Use fetch API with FormData
            fetch("{{ url_for('remove_tag_batch') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message without page reload
                    const flashContainer = document.querySelector('.flash-messages');
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success';
                    alertDiv.textContent = data.message;
                    flashContainer.appendChild(alertDiv);
                    
                    // Remove the tag from the DOM for each selected item
                    selectedItemIds.forEach(itemId => {
                        const item = document.getElementById(`item_${itemId}`).closest('.item');
                        const tagElements = item.querySelectorAll('.item-tags .tag');
                        
                        tagElements.forEach(tagEl => {
                            if (tagEl.childNodes[0].textContent.trim() === tagName) {
                                tagEl.remove();
                            }
                        });
                    });
                    
                    // Update common tags display
                    updateCommonTags();
                    
                    // Update the tag cloud with new counts
                    if (data.tag_counts) {
                        updateTagCloud(data.tag_counts);
                    }
                    
                    // Auto-remove the flash message after 3 seconds
                    setTimeout(() => {
                        alertDiv.remove();
                    }, 3000);
                } else {
                    // Show error message
                    const flashContainer = document.querySelector('.flash-messages');
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-error';
                    alertDiv.textContent = data.message;
                    flashContainer.appendChild(alertDiv);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // Add a new function to update the tag cloud
        function updateTagCloud(tagCounts) {
            const tagCloud = document.getElementById('tag-cloud');
            const selectedTags = new URLSearchParams(window.location.search).getAll('tag');
            const tagSort = document.getElementById('tag-sort');
            const tagFilter = document.getElementById('tag-filter');
            
            // Remember current sort method
            const currentSortMethod = tagSort.value;
            
            // Remember current filter text
            const currentFilterText = tagFilter.value.toLowerCase();
            
            // Clear existing tags
            tagCloud.innerHTML = '';
            
            // Add updated tags - only those with counts > 0 will be in tagCounts
            Object.entries(tagCounts).forEach(([tag, count]) => {
                // Skip tags with zero count
                if (count === 0) return;
                
                const tagDiv = document.createElement('div');
                tagDiv.className = 'tag';
                if (selectedTags.includes(tag)) {
                    tagDiv.classList.add('selected-tag');
                }
                tagDiv.setAttribute('data-count', count);
                tagDiv.textContent = `${tag} (${count})`;
                tagDiv.onclick = function() { toggleTag(tag); };
                
                // Apply current filter
                if (currentFilterText && !tag.toLowerCase().includes(currentFilterText)) {
                    tagDiv.style.display = 'none';
                }
                
                tagCloud.appendChild(tagDiv);
            });
            
            // Re-apply sorting
            const tags = Array.from(tagCloud.getElementsByClassName('tag'));
            tags.sort((a, b) => {
                if (currentSortMethod === 'alpha') {
                    // Sort alphabetically
                    return a.textContent.localeCompare(b.textContent);
                } else {
                    // Sort by count
                    const countA = parseInt(a.getAttribute('data-count'));
                    const countB = parseInt(b.getAttribute('data-count'));
                    return countB - countA; // Descending order
                }
            });
            
            // Re-append tags in sorted order
            tags.forEach(tag => {
                tagCloud.appendChild(tag);
            });
            
            // Re-initialize event listeners for tag filter and sort
            initializeTagFilterAndSort();
        }
        
        // Extract the tag filter and sort functionality into a separate function
        function initializeTagFilterAndSort() {
            const tagFilter = document.getElementById('tag-filter');
            const tagSort = document.getElementById('tag-sort');
            const tagCloud = document.getElementById('tag-cloud');
            const tags = Array.from(tagCloud.getElementsByClassName('tag'));
            
            // Remove existing event listeners
            const newTagFilter = tagFilter.cloneNode(true);
            tagFilter.parentNode.replaceChild(newTagFilter, tagFilter);
            
            const newTagSort = tagSort.cloneNode(true);
            tagSort.parentNode.replaceChild(newTagSort, tagSort);
            
            // Re-add event listeners
            newTagFilter.addEventListener('input', function() {
                const filterText = this.value.toLowerCase();
                
                tags.forEach(tag => {
                    const tagText = tag.textContent.toLowerCase();
                    if (tagText.includes(filterText)) {
                        tag.style.display = '';
                        // 高亮匹配部分
                        if (filterText) {
                            tag.classList.add('tag-highlight');
                        } else {
                            tag.classList.remove('tag-highlight');
                        }
                    } else {
                        tag.style.display = 'none';
                    }
                });
            });
            
            // 排序标签
            newTagSort.addEventListener('change', function() {
                const sortMethod = this.value;
                
                tags.sort((a, b) => {
                    if (sortMethod === 'alpha') {
                        // 按字母排序
                        return a.textContent.localeCompare(b.textContent);
                    } else {
                        // 按数量排序
                        const countA = parseInt(a.getAttribute('data-count'));
                        const countB = parseInt(b.getAttribute('data-count'));
                        return countB - countA; // 降序
                    }
                });
                
                // 重新添加排序后的标签
                tags.forEach(tag => {
                    tagCloud.appendChild(tag);
                });
            });
            
            // Preserve the current filter value
            if (tagFilter.value) {
                newTagFilter.value = tagFilter.value;
                newTagFilter.dispatchEvent(new Event('input'));
            }
            
            // Preserve the current sort method
            newTagSort.value = tagSort.value;
            newTagSort.dispatchEvent(new Event('change'));
        }
        
        // Update the DOMContentLoaded event handler to use the new function
        document.addEventListener('DOMContentLoaded', function() {
            initializeTagFilterAndSort();
            
            const checkboxes = document.querySelectorAll('input[name="selected_items"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateCommonTags);
            });
        });
    </script>
</body>
</html>